
```{r}
library(rvest)
library(tidyverse)
library(SwimmeR)
library(JumpeR)
```

```{r}
# First three blocks are setting up the links from the timing company's pages, in this case Delta Timing.

url <- "http://results.deltatiming.com/"
selector <- "h4 a"

contents <- read_html(url)
links <- html_attr(html_nodes(contents, selector), "href")

links <- links[!links %>% str_detect("xc|rowing|canoe|usack|icf-cam|wwc|flotrack")]
school_pages <- links[links %>%
        str_detect("results.deltatiming")]
links <- links[!(links %in% school_pages)]

links <- ifelse(str_detect(links, "http"), paste0("", links), paste0("http://results.deltatiming.com", links))
links <- links[c(-1, -157)]
```

```{r}
html_fnx <- function(x, select) { html_session(x) %>%
    html_nodes(select) %>%
      html_attr("href")
    }
event_links <- map(links[1:298], html_fnx, "td a")
```

```{r}

event_links <- event_links %>%
  flatten() %>%
  map(str_remove, "/tf") 
event_links <- paste0("http://tfresultsdata.deltatiming.com", event_links, ".htm")

```


```{r}
#remove some high school meets

event_links <- event_links[!event_links %>%
              str_detect("hs")]
```

```{r}

# Links and variables for testing


url_trial <- "http://tfresultsdata.deltatiming.com/2019-miami-power-5-trailblazer-challenge/190322F026.htm"
event_results_trial <- read_results(url_trial)

```

```{r Greg read results}

raw_results <- map(event_links[1:25], safely(read_results, otherwise = NA))
raw_results <- SwimmeR:::discard_errors(raw_results)

raw_results_2 <- unlist(raw_results)

df <- tf_parse(raw_results_2)
```


```{r}
#Isolate event name from results. We'll likely eventually just create a list of events and use is.in or something like that, so we're not dependent on the "Event xyz" format.

event_name <- event_results_trial %>%
  str_match("Event \\d{1,}(.*)$") %>%
  as.data.frame() %>%
  select(V2) %>%
  filter(!is.na(V2)) %>%
  trimws()

event_name
```
```{r}
# Helper / component functions 

# Generic cleaning of results - things that should be done / need to be done to all events from all sources

results_cleaner <- function (event_results) {

remove <- c("\n\\s*", "#\\s*[0-9]*\\s*")
      
event_results <- event_results %>%
    str_remove_all(paste0(remove, collapse="|")) %>%
    tibble() %>%
    rename("event_results" = ".") %>%
    filter(!str_detect(event_results, "DNS")) %>%
    mutate(event_results = trimws(event_results))
 
return(event_results)

}

# Tidy throws and jumps (precursor to parsing out the wind for outdoor horizontal jumps)

horizontal_tidy <- function (event_results) {
 
event_results <- event_results %>%
    pivot_longer(cols = F1:F6, names_to = "Flight", values_to = "Distance") %>%
    mutate(Flight = as.factor(str_remove(Flight, "F")))

return(event_results)

}

# Parse wind from jump distance for outdoor horizontal jumps

wind <- function (event_results) {

event_results <- event_results %>%
    mutate(Distance = str_remove(Distance, "\\)")) %>%
    separate(Distance, into = c("Distance", "Wind"), sep = "([\\( | \\s | \\+])") %>%
    mutate(Wind = ifelse(Wind == '', "0.0", Wind))  # obnoxious little necessary workaround because `separate` coerces 0.0 to blank (not NA, blank)

return(event_results)

}

```

```{r}

### NO TESTING IN THIS BLOCK ###

# Still looking for best way to clean-up "team rankings" when they are inserted via "=====" rows

throw_jump <- function (event_results) {
  
 results <- results_cleaner(event_results)
   
 results <- results %>%
   mutate(ID = row_number()) %>%
   filter(ID >= (which(str_starts(event_results, "1\\s*[A-Z]")))) %>%
   mutate(ID = row_number()) %>%
   mutate(results = (ifelse((ID) %% 2 != 0, event_results[ID + 1], "odd"))) %>%
   filter((ID) %% 2 != 0) %>%
   select(-ID) %>%
   mutate(event_results = str_replace_all(event_results, "[0-9+]", " ")) %>%
   mutate(event_results = str_replace(event_results, "..\\sm(.*)", "")) %>%
   mutate(results = str_replace_all(results, "m", "")) %>%
   separate(results, c("F1", "F2", "F3", "F4", "F5", "F6"),  "\\s{1,}") %>%
   rename("Athlete" = event_results) %>%
   mutate(Event = event_name)

 results <- horizontal_tidy(results)
 
 #results <- wind(results)
 
  return(results)
}

df <- throw_jump(event_results_trial)

```

```{r}

vault_highjump <- function (event_results) {
   
results <- results_cleaner(event_results)   
   
results <-  results %>%
   mutate(event_results = trimws(event_results)) %>%
   mutate(ID = row_number()) %>%
   filter(ID >= which(str_starts(event_results, "1\\s*[A-Z]"))) %>%
   mutate(ID = row_number()) %>%
   mutate(heights = ifelse(str_starts(event_results, "[0-9]{1,2}\\s*[A-Z]"), event_results[ID + 1], "NA"), 
          results = ifelse(str_starts(event_results, "[0-9]{1,2}\\s*[A-Z]"), event_results[ID + 2], "NA")) %>%
   filter(heights != "NA" | results != "NA") %>%
   select(-ID) %>%
   mutate(event_results  = str_replace_all(event_results, "[0-9]", " ")) %>%
   mutate(event_results = str_replace_all(event_results, "..\\sm(.*)", ""))

 heights <- as.data.frame(str_split_fixed(results$heights, "\\s{1,}", 12))
 marks <- as.data.frame(str_split_fixed(results$results, "\\s{1,}", 12))
 
heights <- set_names(heights, paste0(colnames(heights), "_", "Bar")) 
marks <- set_names(marks, paste0(colnames(marks), "_", "Outcome")) 

# Tidy up! Because of the unusual arrangement of vertical jumps - fixed bar height progessions, 1-3 outcomes per height, open-ended number of bar heights - tidying is more than an academic exercise here. Anything other than a standard display of results requires the data to be tidy.

results %>%
   bind_cols(heights, marks) %>%
   select(-results, -heights) %>%
   pivot_longer(
      cols = !event_results,
      names_to = c("height", ".value"),
      names_sep = "_"
   ) %>%
   filter(Bar != "")

}

df_vault <- vault_highjump(event_results_trial)

```



